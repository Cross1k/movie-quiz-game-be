import express from "express";
import pino from "pino-http";
import cors from "cors";
import http from "http";

import { nanoid } from "nanoid";
import { v2 as cloudinary } from "cloudinary";

import { Server } from "socket.io";

import { getEnvVar } from "./utils/getEnvVar.js";
import { CLOUDINARY } from "./utils/cloudinary.js";

const PORT = Number(getEnvVar("PORT", "3000"));

cloudinary.config({
  secure: true,
  cloud_name: getEnvVar(CLOUDINARY.CLOUDNAME),
  api_key: getEnvVar(CLOUDINARY.CLOUDAPIKEY),
  api_secret: getEnvVar(CLOUDINARY.CLOUDAPISECRET),
});

const gamesList = {};

// const gamesList = session_12345: {  // ID —Å–µ—Å—Å–∏–∏ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
//     host: {
//       _id: "host_001",
//       socketId: "socket_abc123",
//     },
//     players: [
//       {
//         _id: "player_001",
//         socketId: "socket_xyz456",
//         name: "–ò–≥—Ä–æ–∫ 1",
//         score: 0,
//       },
//       {
//         _id: "player_002",
//         socketId: "socket_xyz789",
//         name: "–ò–≥—Ä–æ–∫ 2",
//         score: 0,
//       },
//       {
//         _id: "player_003",
//         socketId: "socket_xyz999",
//         name: "–ò–≥—Ä–æ–∫ 3",
//         score: 0,
//       },
//     ],
//     gamePage: {
//       currentFrame: 1,  // –¢–µ–∫—É—â–∏–π –∫–∞–¥—Ä —Ñ–∏–ª—å–º–∞
//       movieTitle: "–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä",  // –¢–µ–∫—É—â–∏–π —Ñ–∏–ª—å–º
//       isPaused: false,  // –ò–≥—Ä–∞ –Ω–∞ –ø–∞—É–∑–µ –∏–ª–∏ –Ω–µ—Ç
//     },
//   },
// };

const moviesList = {};

//   session_1: {
//     theme: {
//       "Action Movies": [
//         { index: 0, name: "Die Hard", guessed: false },
//         { index: 1, name: "Mad Max: Fury Road", guessed: false }
//       ],
//       "Sci-Fi": [
//         { index: 0, name: "Interstellar", guessed: false },
//         { index: 1, name: "Blade Runner 2049", guessed: false }
//       ]
//     }
//   },
//   session_2: {
//     theme: {
//       "Horror": [
//         { index: 0, name: "The Conjuring", guessed: false },
//         { index: 1, name: "IT", guessed: false }
//       ]
//     }
//   }
// };

export const setupServer = () => {
  const app = express();
  const server = http.createServer(app);

  const io = new Server(server, {
    // cors: { origin: "https://movie-quiz-psi.vercel.app" }, // use it on prod
    cors: { origin: "*" },
  });

  app.use(cors());

  app.use(
    pino({
      transport: {
        target: "pino-pretty",
      },
    })
  );

  app.get("/", (req, res) => {
    res.json({
      message: "Hello world!",
    });
  });

  io.on("connection", (socket) => {
    console.log("–ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:", socket.id, socket.handshake.time);

    socket.on("create_session", (room) => {
      gamesList[room] = {
        host: null, // –ü–æ–∫–∞ –Ω–µ—Ç —Ö–æ—Å—Ç–∞
        players: [], // –ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤
        gamePage: null, // –ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–≥—Ä–µ
      };
      // socket.join(room);
      if (gamesList[room]) {
        console.log(`–°–µ—Å—Å–∏—è —Å ID ${gamesList[room]} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
        return;
      }

      console.log("–°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞:", room);
    });

    socket.on("join_room", (room, playerId, playerName) => {
      if (gamesList[room]?.players.find((player) => player._id === playerId)) {
        console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID ${playerId} —É–∂–µ –≤ —Å–µ—Å—Å–∏–∏ ${room}`);
        return;
      }
      if (gamesList[room]?.players.length >= 3) {
        console.log(`–°–µ—Å—Å–∏—è ${room} —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞. –ú–∞–∫—Å–∏–º—É–º –∏–≥—Ä–æ–∫–æ–≤: 3`);
        return;
      }

      gamesList[room]?.players.push({
        _id: playerId,
        socketId: socket.id,
        name: playerName,
        score: 0,
      });

      socket.join(room);
      console.log(`–ò–≥—Ä–æ–∫ ${playerId} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —Å–µ—Å—Å–∏–∏${room}:`);

      if (gamesList[room]?.host && gamesList[room].players.length === 3) {
        io.to(room).emit("game_page", room);
        console.log(`–ö–æ–º–Ω–∞—Ç–∞ ${room} –ø–æ–ª—É—á–∏–ª–∞ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥.`);
      } else {
        console.log(`–ö–æ–º–Ω–∞—Ç–∞ ${room} –Ω–µ –≥–æ—Ç–æ–≤–∞ –∫ –∏–≥—Ä–µ.`);
        return;
      }
    });

    socket.on("host_page_id", (room, id, _id) => {
      // –ï—Å–ª–∏ —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      if (!gamesList[room]) {
        console.log(`–°–µ—Å—Å–∏—è ${room} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);
        return;
      }

      const session = gamesList[room];

      // –ï—Å–ª–∏ —Ö–æ—Å—Ç–∞ –≤ —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ
      if (!session.host) {
        session.host = { id: _id, socketId: id };
        socket.join(room);
        console.log(`–î–æ–±–∞–≤–ª–µ–Ω —Ö–æ—Å—Ç –≤ —Å–µ—Å—Å–∏—é ${room}:`, session.host);
        return;
      }

      // –ï—Å–ª–∏ —Ö–æ—Å—Ç —É–∂–µ –µ—Å—Ç—å, –Ω–æ ID —Å–æ–≤–ø–∞–¥–∞—é—Ç, –∞ socketId –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º socketId
      if (session.host.id === _id) {
        if (session.host.socketId !== id) {
          session.host.socketId = id;
          console.log(
            `–û–±–Ω–æ–≤–ª–µ–Ω socketId —Ö–æ—Å—Ç–∞ –≤ —Å–µ—Å—Å–∏–∏ ${room}:`,
            session.host
          );
        } else {
          console.log(
            `–•–æ—Å—Ç –≤ —Å–µ—Å—Å–∏–∏ ${room} —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.`
          );
        }
        return;
      }

      // –ï—Å–ª–∏ –≤ —Å–µ—Å—Å–∏–∏ —É–∂–µ –µ—Å—Ç—å —Ö–æ—Å—Ç —Å –¥—Ä—É–≥–∏–º hostId ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
      console.log(
        `–í —Å–µ—Å—Å–∏–∏ ${room} —É–∂–µ –µ—Å—Ç—å –¥—Ä—É–≥–æ–π —Ö–æ—Å—Ç, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.`
      );
    });

    socket.on("game_page_id", (room, gameId) => {
      if (gamesList[room].gamePage === null) {
        gamesList[room].gamePage = gameId;
        socket.join(room);
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º io.to –≤–º–µ—Å—Ç–æ socket.to –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–æ–∫–µ—Ç—É
        io.to(gamesList[room].host.socketId).emit("send_game_page_id", gameId);
        console.log(
          gameId,
          "ID –∏–≥—Ä–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ö–æ—Å—Ç—É:",
          gamesList[room].host.socketId
        );
      } else if (gamesList[room].gamePage === gameId) {
        console.log(`ID –∏–≥—Ä–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ö–æ—Å—Ç—É: ${gameId}`);
        return;
      } else {
        console.log(
          `ID –∏–≥—Ä–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ö–æ—Å—Ç—É: ${gamesList[room].gamePage}, –Ω–æ–≤—ã–π ID: ${gameId}`
        );
        return;
      }
    });

    /* - THEMES, MOVIES - */

    socket.on("get_themes", async (room) => {
      if (!moviesList[room]) {
        moviesList[room] = { themes: {} };
      }

      try {
        console.log("üì° –ó–∞–ø—Ä–æ—Å —Ç–µ–º –∏ —Ñ–∏–ª—å–º–æ–≤...");

        const themesResult = await cloudinary.api.sub_folders(
          "movie-quiz/themes"
        );

        for (const theme of themesResult.folders) {
          if (!moviesList[room].themes[theme.name]) {
            moviesList[room].themes[theme.name] = { movies: [] };

            const moviesResult = await cloudinary.api.sub_folders(
              `movie-quiz/themes/${theme.name}`
            );

            moviesList[room].themes[theme.name].movies =
              moviesResult.folders.map((movie, index) => ({
                index,
                name: movie.name,
                guessed: false,
                whoGuessed: null,
              }));
          }
        }

        io.emit("themes_list", moviesList[room].themes);
        console.log("üì° –¢–µ–º—ã –∏ —Ñ–∏–ª—å–º—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:", moviesList[room].themes);
      } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ç–µ–º –∏ —Ñ–∏–ª—å–º–æ–≤:", error);
      }
    });

    socket.on("select_movie", async (themeName, movieName, gameId) => {
      try {
        const result = await cloudinary.api.resources_by_asset_folder(
          `movie-quiz/themes/${themeName}/${movieName}`
        );
        const framesList = () => {
          result.resources.map((frame) => frame.url);
          // return frames.push
        };
        console.log(`üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ${framesList()} –∫ ${gameId}`);
        io.to(gameId).emit("open_frame", framesList());
      } catch (error) {
        console.log("error", error.message);
      }
    });

    socket.on("change_frame", (gameId) => {
      io.to(gameId).emit("change_frame");
      console.log("FRAME, sended to", gameId);
    });

    socket.on(
      "show_logo",
      (gameId, room, playerName, movieTheme, movieName) => {
        moviesList[room].theme[movieTheme].movies[movieName].guessed = true;
        moviesList[room].theme[movieTheme].movies[movieName].whoGuessed =
          playerName;

        socket.to(gameId).emit("show_logo", moviesList[room]);
        console.log("LOGO, sended to", gameId);
      }
    );

    /* - ANSWERS - */

    socket.on("give_answer", (room, playerName) => {
      console.log(`–û—Ç–≤–µ—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${playerName} –≤ —Å–µ—Å—Å–∏–∏ ${room}`);
      socket.broadcast.to(room).emit("broadcast_answer", playerName);
    });

    socket.on("bad_answer", (room) => {
      console.log(`–ù–µ –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —Å–µ—Å—Å–∏–∏ ${room}`);
      socket.to(room).emit("broadcast_bad_answer");
    });

    socket.on("send_points", (pts, room, playerName, gameId) => {
      if (!gamesList[room]) {
        console.log(`–°–µ—Å—Å–∏—è ${room} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);
        return;
      } else {
        const playerIndex = gamesList[room].players.findIndex(
          (player) => player.name === playerName
        );

        if (playerIndex === -1) {
          console.log(`–ò–≥—Ä–æ–∫ ${playerName} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ—Å—Å–∏–∏ ${room}.`);
        } else {
          gamesList[room].players[playerIndex].score += pts; // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–ª–ª
          console.log(
            `–ò–≥—Ä–æ–∫ ${playerName} –ø–æ–ª—É—á–∏–ª ${pts} –±–∞–ª–ª! –¢–µ–∫—É—â–∏–µ –æ—á–∫–∏: ${gamesList[room].players[playerIndex].score}`
          );
        }
      }
      io.to(gameId).emit("all_points", gamesList[room].players);
      io.to(playerName).emit(
        "your_points",
        gamesList[room].players[playerIndex].score
      );
    });

    socket.on("end_game", (room, highScore, playerName) => {
      socket.broadcast.to(room).emit("end_game", highScore, playerName);
      gamesList[room] = null;
      moviesList[room] = [];
      console.log(
        `–ò–≥—Ä–∞ ${room} –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–æ–±–µ–¥–∏—Ç–µ–ª—å ${playerName} —Å–æ —Å—á–µ—Ç–æ–º ${highScore}`
      );
    });

    socket.on("disconnect", () => {
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è:", socket.id);
    });
  });

  app.get("*", (req, res, next) => {
    res.status(404).json({
      message: "Not found",
    });
  });

  app.use((err, req, res, next) => {
    res.status(500).json({
      message: "Something went wrong",
      error: err.message,
    });
  });

  server.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
  });
};
